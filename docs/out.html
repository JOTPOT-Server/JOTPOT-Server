<div ID="main-container">
<style>
	
	#main-container {
		
		font-family: Arial, Helvetica, sans-serif;
		background-color: #fff;
		color: #004;
		padding: 8px;
		padding-left: 20px;
		padding-right: 50px;
		text-align: left;
		
	}
	
	h1,h2,h3 {
		
		font-family: Arial, Helvetica, sans-serif;
		color: #008;
		
	}
	
	a {
		
		background-color: #e0e0e0;
		box-sizing: border-box;
		border-radius: 3px;
		padding: 3px;
		color: #008;
		
	}
	
	.details {
		
		padding: 0px;
		font-size: 0.9em;
		padding-left: 15px;
		
	}
	
	.details>ul {
		
		margin: 3px;
		margin-left: -15px;
		font-size: 0.85em;
		
	}
	
	.supported {
		
		color: green;
		
	}
	
	.notsupported {
		
		color: red;
		
	}
	
	.func-h3 {
		
		margin-bottom: 0px;
		
	}
	
	.args-list {
		
		font-size: 1.2em;
		margin-top: 3px;
		margin-bottom: 10px;
		padding-left: 45px;
		
	}
	
	.desc {
		
		font-size: 1.15em;
		padding-left: 55px;
		margin-top: -5px;
		
	}
	
	.indent {
		
		padding-left: 20px;
		
	}
	
</style>
<h1>JOTPOT Server Docs</h1>
<a href="/server" style="float: right;" ID="the_link">JOTPOT Server Main Page</a>
<div class="indent">
<i>Please note that this page is still a work in progress, and is no where near complete. It may not look the best yet but the content should be good :)</i>
<h2>Getting started</h2>
<div class="indent">
	Welcome the the documentation for JOTPOT Server, this first section is a guide on getting started with JOTPOT Server.
	<br>JOTPOT Server is a multipurpose server that is designed to elegantly forfill a variety of tasks. The most simple function of JOTPOT Server is as a standard file server. Even if you are starting a more complex server, the following setup is almost universal.
	
	<h3>Download</h3>
	<br>To start the <i>first method</i>, we will download the basic files that we need, all these downloads are available on <a href="https://www.jotpot.co.uk/server" target="_blank">jotpot.uk/server</a>. JOTPOT Server is writen in JavaScript for <a href="https://nodejs.org" target="_blank">Node.js</a> and also a bit of <a href="https://golang.org">Go</a>. The main server software is writen for Node.js, with some more advanced fetures such as the load balencer writen in Go. For this reason, there are a few different ways of running JOTPOT Server. The first is to run the server with Node.js. To do this, make sure that you either have Node.js installed or have a binary for it. It is recomended that you use a stable version from v6 onwards. And make sure that it is up-to-date with all the latest security and stabibility updates. Node.js can be downloaded from <a href="https://nodejs.org/en/download/" target="_blank">nodejs.org/en/download</a>. Once installed, download and extract the Node.js source from <a href="https://www.jotpot.co.uk/server" target="_blank">jotpot.uk/server</a>.
	<br>Here is an example of downloading the source from the linux command line:
	<pre>
	wget https://www.jotpot.co.uk/releases/25D/jps.tar.gz
	tar -xzf jps.tar.gz
	rm jps.tar.gz
</pre>
	The source should then be in your current directory.
	<br>This source contains the basic configuration so there is no need to download anything else if you are using this method.
	<br><i>Another method</i> of downloading JOTPOT Server is to download a version of Node.js that contains JOTPOT Server and has already been compiled into a binary, these are also available for a veriaty of platforms at <a href="https://www.jotpot.co.uk/server" target="_blank">jotpot.uk/server</a>. If your platform is not supported you can compile your own (instructions on the download page), or just run it from Node.js (which is probably easier at this point).
	<br>When you have the correct binary, you will also need a configuration file and an error page, these can be downloaded also from <a href="https://www.jotpot.co.uk/server" target="_blank">jotpot.uk/server</a> under the downloads titled 'A simple HTTP server connfig.json file' and 'The default error page'. Put these downloads into the same directory as the binary, andy you are ready to go!
	
	<h3>Setting things up</h3>
	JOTPOT Server looks for the files to serve in the sites directory, each host should have a directory within this where it's webspace is contained. For example, if you were hosting the website 'example.com', then in your directory with the main server files - the one with the configuration file etc. - you would setup a directory named 'sites', and within that, one named 'example.com'. Please notes that port numbers other than 80 and 443 (for default HTTP and HTTPS) are included in the directory name, so <b>when the server recieves a request with the host 'example.com:8080', JOTPOT Server looks under 'sites/example.com;8080' - note how the colon is replaced with a semi-colon</b>.
	<br>For localhost, we can set this up like this on Linux:
	<pre>
	mkdir sites
	mkdir sites/localhost
</pre>Or on Windows:
	<pre>
	md sites
	md sites/localhost
</pre>
	When JOTPOT Server recieves a request, by default, it looks for that file, it will attempt to stat it. So a request for 'example.com/hello.html' would cause the server to stat 'sites/example.com/hello.html', if the file exists and is a file, then JOTPOT Server will serve that file. If it is a directory, then it will then attempt to stat 'sites/example.com/hello.html/index.html', and if that is a file, it will serve that. If 'sites/example.com/hello.html' doesn't exist, it looks for the filename, however with a '.page' extension, so 'sites/example.com/hello.html.page'. This can be useful if you would like 'example.com/hello' to load 'sites/example.com/hello.page'. If no file can be found, it responds with a 404, we will talk more about error responses later.
	<br>However, if the directory 'sites/example.com' doesn't exist, it will return a 404, unless the 'useDefaultHostIfHostDoesNotExist' property in the config.json file is set to true (from 25F onwards), in which case, it will act as if the host is the 'defaultHost' property in the config.json file, so if the default host were 'default' and the 'sites/example.com' directory didn't exist, it would instead look in the 'sites/default' directory.
	<br><br>Before you run, you might want to change a few settings in the config.json file. THe first one you might want to change is the port for the default HTTP server. It will be set to port 80, the default port for HTTP, however on Linux, you have to run it as root to be able to use that port (as is is below port 1024, and thus a priveliged port) and also some other programmes you have running might be using that port, such as skype using port 80 on windows. If the port you are trying to use is in use, you will get the error: EADDRINUSE (error address in use), that is a sign you need to stop the programme using that port or change the port.
	<br>You can change the port by looking under the httpservers property in the config.json file and changing ' "port": 80, ' to ' "port": 8080, ' or whatever number you like.
	<br>You will then need to rename your localhost directory from 'localhost' to 'localhost;8080' (replace 8080 with the port number you used).
	
	<h3>Making a simple website</h3>
	So obviously, as a web server, it serves HTML to the browser. This tutorial is made with the assumption that you understand basic HTML, if you don't check out <a href="https://www.w3schools.com/html/default.asp" target="_blank">W3Schools HTML tutorial</a> or <a href="https://developer.mozilla.org/en-US/docs/Learn/Getting_started_with_the_web/HTML_basics" target="_blank">MDN HTML Basics</a> (or both if you have too much time).
	<br>Before we run, we will create a basic website for you to test it out on.
	<br>For the sake of this tutorial, we recomend creating 3 files, index.html, page2.html and page3.page - you can write whatever HTML you want inside these files, and save them into 'sites/localhost;&lt;YOUR PORT NUMBER HERE&gt;'
	<pre>
		Your directory structor might now look a bit like this:
		
		J:.
		│   config.json
		│   errorTemp.jpt
		│   jps.exe
		│
		└───sites
		    └───localhost;8080
		            index.html
		            page2.html
					page3.page
	
	</pre>
	
	<h3>Run!</h3>
	Running JOTPOT Server is simple, if you downloaded the binary, just navigate to the directory with your config.json file, errorTemp.jpt and sites directory and run the jps or jps.exe.
	For example on Linux:
	<pre>
	/ $  cd /path/to/jotpot/server
	/path/to/jotpot/server $  ./jps
</pre> Or on windows:
	<pre>
	/> cd /path/to/jotpot/server
	/path/to/jotpot/server> jps
</pre>
	If you downloaded the Node.js source and have Node.js installed, here is an example of how to run it on Linux:
	<pre>
	/ $  cd /path/to/jotpot/server
	/path/to/jotpot/server $  node run
</pre> Or on windows:
	<pre>
	/> cd /path/to/jotpot/server
	/path/to/jotpot/server> node run
</pre>
	On windows, you will have to add a firewall exception, and on linux, if you are createing a server on a priveliged port (port number below 1024), you will have to run it as root, so begin the command with sudo - although this isn't recomended, you can set it up so that traffic into port 80 goes to port 8080 for example either on your router or with iptables on Linux, there is a <a href="https://www.cyberciti.biz/faq/linux-port-redirection-with-iptables/" target="_blank">guide from nixCraft here</a>.
	<br>Now, you can load up your browser, and head to http://localhost:&lt;YOUR PORT NUMBER HERE&gt;. This will load up the index.html page in your localhost;&lt;YOUR PORT NUMBER HERE&gt; directory. Then, go to http://localhost:&lt;YOUR PORT NUMBER HERE&gt;/page2.html and you will see your other webpage, or go to http://localhost:&lt;YOUR PORT NUMBER HERE&gt;/page3 to see your page3.page file.
	<h3>Going a bit further (just a bit, we havn't even got to extensions yet ;)</h3>
	Now, you can try and access your server from another computer! To do this, find your local IP address, in linux, use the ifconfig command, work out which interface you are using (mine is eth0, as it is the first eth (ethernet connection), you might be using wlan0 or a seperate one) and read off the inet addr value, for example 192.168.1.103. And on windows use the ipconfig command, work out which adapter you are using, mine is the 'Ethernet adapter Ethernet', as mine is an ethernet connection, and read off the IPv4 Address value, again could be somthing along the lines of 192.168.1.103.
	<br>Remember those numbers. Go to another PC (for now, make sure it is on the same local area network (LAN) as the PC you are using as the server), and open the web browser. No go to http://&lt;YOUR.IP.ADDRESS.HERE&gt;:&lt;YOUR PORT NUMBER HERE&gt; (you don't need to add the :PORT part if you are using port 80 as 80 is the default port for HTTP).
	<br>You will notice that it responds with a 404: Not Found error, this is because it is now looking in 'sites/&lt;YOUR.IP.ADDRESS.HERE&gt;:&lt;YOUR PORT NUMBER HERE&gt;' for index.html, we could solve this be creating a new directory with that name. But we could also use a feture of JOTPOT Server called host aliasing. This allows you to set an alias up for a host, so host-a.com could be processed as host-b.com. We can set this alias in the config.json file. Find the property named "hostAlias". In the default config, the value will be '{}', if we set it to '{"host-a.com":"host-b.com"}', then host-a.com will be habdled as host-b.com. This can continue as such: '{"host-a.com":"host-b.com", "some-other-website.co.uk":"some-other-website.com"}'. With a comma seperating the values.
	<br>So to set up the alias you want, we can set the "hostAlias" property to '{"&lt;YOUR.IP.ADDRESS.HERE&gt;:&lt;YOUR PORT NUMBER HERE&gt;":"localhost:&lt;YOUR PORT NUMBER HERE&gt;"}'
	<br>Then, reboot the server. So this by focusing on the command window it is running in and pressing ctrl+c to kill the programme. If this doesn't work on Windows (due to changed defaults), just close the window. Then rerun the server and the config.json will be reloaded. Now try from the other computer again and your index.html file should pop up!
	<br><br>To connect to your server from another PC that is not on your network, you will need to know your global IP address, the one that points to you from outside of your LAN. You can get your global IP address from <a href="https://jotpot.co.uk/whatsmyip" target="_blank">jotpot.uk/whatsmyip</a>. You will then need to set up your router to let traffic on your chosen port get to your PC, this is knowen as port forwarding. Make sure that the port you want to use externaly (this could be port 80, the default for HTTP remember or another port), forwards to the port that the server is running on on your PC.
	<br>There are some guides available for setting port forwarding up from: <a href="http://www.pcworld.com/article/244314/how_to_forward_ports_on_your_router.html" target="_blank">PCWorld</a>, <a href="http://www.wikihow.com/Set-Up-Port-Forwarding-on-a-Router" target="_blank">wikiHow</a>, <a href="http://bt.custhelp.com/app/answers/detail/a_id/8790/~/how-do-i-set-up-port-forwarding-on-my-bt-hub%3F" target="_blank">BT</a>, <a href="https://www.howtogeek.com/66214/how-to-forward-ports-on-your-router/" target="_blank">How-To Geek</a> and many others with <a href="https://www.google.com/search?q=how+to+set+up+a+port+forward" target="_blank">a quick Google search for "how to set up port forwarding"</a> (the How-To Geek one goes in to the most exciting detail)
	<br>Then, you will need to set up another host alias (just as we did before), but this time from &lt;YOUR.GLOBAL.IP.ADDRESS&gt;:&lt;The port you chose to forward from&gt; - remembering that if we chose port 80, we dont need the ':80' at the end. And still to 'localhost:&lt;The port your server is running on&gt;'
	<br>Reboot the server once more and try to connect via your global IP. If all is good, you should be able to access your web server from anywhere in the world now. However you ight need to bare in mind that if you have a dynamicaly assigned IP address, your IP address will change from time to time, so you might need to keep on top of that.
	<br>From there, you can buy a domain name and point that to your IP and turn your website into whatever you like.
	<br>Buying a domain is one way to prevent the constant changing of the host aliases in the config file, but, as mentioned earlier, another way would be to use the default host.
	<br>So for this, lets rename out localhost directory to 'default', this could be anything, but default makes sense. We should then set our "defaultHost" property in the config.json file to the name of our directory. Luckily, the default one you downloaded, already has this. Then make sure that the "useDefaultHostIfHostDoesNotExist" property is set to true, before rebooting the server. You can also remove all the aliases now as they are no longer required.
	<br>After the reboot, no matter what host you use to connect to your server, as long as ther isn't a directory for it, it will use the 'sites/default' directory, however if you were to register 2 domains, say "host-a.com" and "host-b.com", you could still have sperate directory's for them 'sites/host-a.com' and 'sites/host-b.com', while everythign else will go to 'sites/default'.
	<br><br>The rest of the docs dive deeper into JOTPOT Server, it covers the config.json file and also extensions - that give you the power to modify the behavior of JOTPOT Server and add server-side logic and scripting. Have fun and thank you for using JOTPO Server :)
	<br><a href="https://github.com/JOTPOT-UK/JOTPOT-Server" target="_blank">JOTPOT Server is all open source on GitHub, so if you encounter any problems, or have any fetures you would like to suggest or add yourself, head over there.</a>
	<br><br>
</div>
<h2>The config.json file</h2>
<span class="indent">This JSON file contains the basic configuration for JOTPOT Server. There are simple versions and demo versions available from <a href="/server">jotpot.co.uk/server</a></span>
<div class="indent">
Properties:
	<br>
	<br>'httpServers': Array. Each item of the array should be an object containing the HTTP server options.
	<br>'httpsServers': Array. Each item of the array should be an object containing the HTTPS server options.
	<br>'redirectToHttps': Array. Each item of the array should be a string of any domains you want to be permanently redirected to the https version of the site.
	<br>'canBeHttp': Array. Each item should be paths you do NOT want redirecting to HTTPS if the domain normally gets redirected.
	<br>'dataPort': Number, the port you would like the data connections to come though, see data connections.
	<br>'hostRedirects': Object. Format: {"host_you_want_redirecting.com":"host_to_redirect_to.com"}
	<br>'hostAlias': Object. Similar to hostRedirects however rather then redirecting the server will handle the request as if it came from the domain you set - without the user being redirected.
	<br>'pageAlias': Object. The same as hostAlias however with pages instead. Note the format: {"example.com/page1":"example.com/page2"}. If the user goes to example.com/page2, it will be handles as if it were example.com/page1.
	<br>'addVarsByDefault': Boolean, true to replace anything served in the format "$:::&lt;var name>:::$" with the value of the variable or false to not replace be default.
	<br>'doVarsForIfNotByDefault': Array of Strings. The strings should be in the format: "&lt;hostname>/&lt;path>", any pages included in this array will have variables added to them even if doing them by default is set to false.
	<br>'cache': Array of Strings. Each item is in the format "&lt;host&gt;/&lt;page&gt;", this will be cached.
	<br>'errorTemplate': String. The file to use as the error page.
	<br>'defaultHost': String. The host to use by default if the http request contains no host header or useDefaultHostIfHostDoesNotExist is true and the host requested doesn't exist.
	<br>'useDefaultHostIfHostDoesNotExist': Boolean. true if the default host should be used like an alias if the host the user is requesting does not exist.
	<br>'behindLoadBalencer': Boolean. true if headers set be the JOTPOT Server load balencer should be used, for example when determining the source IP address or if the request was HTTPS.
	<br>
	<br>HTTP Server Options:
	<br>'port': Number, the port you would like the server to be opened on.
	<br>
	<br>HTTPS Server Options:
	<br>'port': Number, the port you would like the server to be opened on.
</div>
<br><br>
<h2>What are JOTPOT Server extensions and how do they work?</h2>
<div class="indent">
	JOTPOT Server allows JavaScript files to be run and take control over the server, anything is possible via extensions and 'limited' extensions can be run to ensure an extension can only handle requests etc. from a specific domain/domains for security and stability.
	<br>
	Any file in the working directory of the server, with the full filename ending in '.jpe.js' will be loaded as extensions. There are 2 types of extensions, 'Master' extensions, and 'worker' extensions. JOTPOT Server runs using the 
	<a href="https://nodejs.org/dist/latest-v6.x/docs/api/cluster.html">Node.js cluster modules</a>, 
	this means that there is a master process and then an amount of workers. The master process runs all extensions (where the server.isMaster variable will be true) and each worker runs all the extensions (where the server.isMaster variable is false). 
	They have some shared API features however some different features.
	<br>
	Every extension is loaded with the standard Node.js require function, console object, setTimeout along with the setInterval and setImmediate functions.
	<br>
	There is also a 'server' object for controlling and interacting with the current JOTPOT Server instance, documented below.
	<br>
	The most key consent of extensions is server.handle, and for developing simple applications, it can be all that is needed.
</div>
<br><br>
<h2>'server' object</h2>
<div class="indent">
	<span>The server object is an object available is master and worker extensions, however with differences in each.</span>
	<div ID="server-callFunc"><h3 class="func-h3">server.callFunc(funcName[, ...arguments])</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="supported">Yes</span></li></ul>Added: 25A</div><ul class="args-list"><li>funcName &lt;String&gt; Name of the function to call.</li><li>...arguments Arguments to call the function with.</li></ul><div class="desc">	Calls a function in the master process that was set by <a href="#server-setFunc">server.setFunc()</a> in a master extension.
	<br>
	Returns a promise that resolves with the returned value of the called function.
</div></div><div ID="server-config"><h3 class="func-h3">server.config</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: 25A</div><ul class="args-list"></ul><div class="desc">	Object created from the config.json file, used to determine settings during runtime, you can modify it and the changes will be applied.
	<br>
	Please note that some changes such as server.config.dataPort are set when JOTPOT Server loads and thus changing them after the initial load will not have any effect. These can however be changed as soon as the extension is loaded as the server is set up after the extensions are loaded.
</div></div><div ID="server-createAccountSystem"><h3 class="func-h3">server.createAccountSystem(options)</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="supported">Yes</span></li></ul>Added: Pre 25A</div><ul class="args-list"><li>options &lt;Object&gt; Options to create the account system with.</li></ul><div class="desc">	Created an account system with the given options, documentation coming soon.
</div></div><div ID="server-getData"><h3 class="func-h3">server.getData(request)</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="supported">Yes</span></li></ul>Added: Pre 25A</div><ul class="args-list"><li>request &lt;Server Request&gt; Request to read the data from.</li></ul><div class="desc">	Returns a promise that resolves with all data sent by the client. It resolves when the request is ended.
</div></div><div ID="server-getGlobal"><h3 class="func-h3">server.getGlobal(variableName[, modifying])</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="supported">Yes</span></li><li>Limited worker extention: <span class="supported">Yes</span></li></ul>Added: Pre 25A</div><ul class="args-list"><li>variableName &lt;String&gt; Name of the variable to retrieve.</li><li>modifying &lt;Boolean&gt; Whether or not the variable is being 'modified'.</li></ul><div class="desc">	Gets a server wide global variable. In the master process, it will resolve instantly.
	<br>
	Returns a Promise, resolves with the value of the global variable.
	<br>
	See also: <a href="#server-setGlobal">server.setGlobal()</a>
</div></div><div ID="server-getMimeType"><h3 class="func-h3">server.getMimeType(filename)</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: Pre 25A</div><ul class="args-list"><li>filename &lt;String&gt; The filename to get the mime type of.</li></ul><div class="desc">	Returns the mime type of the filename passed.
</div></div><div ID="server-getUserID"><h3 class="func-h3">server.getUserID(request, response)</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: Pre 25A</div><ul class="args-list"><li>request &lt;Server Request&gt; The request object to get the user ID from.</li><li>response &lt;Server Response&gt; The response object to get the user ID from.</li></ul><div class="desc">	Returns the user ID of the user making this request. If the user doesn't already have a user ID it will create one for it.
	<br>
	Note that if it creates a new user ID, the set-cookie header will be set, and overwriting it will cause the user ID to be invalidated.
</div></div><div ID="server-handle"><h3 class="func-h3">server.handle(events, callback)</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="supported">Yes</span></li><li>Limited worker extention: <span class="supported">Yes</span></li></ul>Added: Pre 25A</div><ul class="args-list"><li>events &lt;Array&lt;String&gt;|String&gt; An event or array of events this function should handle.</li><li>callback &lt;Function&gt; Function to call to handle the event.</li></ul><div class="desc">	Setting a handle for an event allows the function to overwrite or add to the default behavior for the event being handled.
	<br>
	The function should return undefined, a Boolean or a promise - that should resolve with undefined or a Boolean.
	<br>
	If the function returns true or the returned promise resolves true then the server will consider the event 'handled' and thus not continue with the default behavior
	<br>
	All the events that can be handles are detailed in the Server Events section.
</div></div><div ID="server-limited"><h3 class="func-h3">server.limited</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="supported">Yes</span></li><li>Limited worker extention: <span class="supported">Yes</span></li></ul>Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">	true if the extension is limited, false if not.
</div></div><div ID="server-loadExt"><h3 class="func-h3">server.loadExt(path[, lock])</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: Pre 25A<br>Notes: Available in limited extensions until 25D</div><ul class="args-list"><li>path &lt;String&gt; Path of the file to run.</li><li>lock &lt;Lock&gt; Optional lock to apply to the extension.</li></ul><div class="desc">	Loads and runs the path given as an extension. If a lock argument is given, that lock will be applied to the extension. Use the <a href="#server-lock">server.lock</a> class to create a valid lock.
	<br>
	If the current extension is a master extension, the new extension will be loaded as a master extension and if the extension is a worker extension the new extension will also be loaded as a worker extension, only in the process of the current extension - so to ensure an extension can handle all server events it must be loaded all times its parent extension is loaded.
</div></div><div ID="server-lock"><h3 class="func-h3">new server.lock([variableSandbox, mode, hosts])</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: 25A<br>Note: From 25D the server.lock is actually an extension of the actually lock class to prevent it from being overwritten and causing errors.</div><ul class="args-list"><li>variableSandbox &lt;String|null&gt; Name of sandbox to use for global variables, or null if no sandbox.</li><li>mode &lt;Number&gt; Optional lock to apply to the extension.</li><li>hosts &lt;Array&lt;String&gt;&gt; Array of strings this extension is allowed to handle events for.</li></ul><div class="desc">	If variableSandbox is a string, all server wide global variables set with <a href="#server-setGlobal">setGlobal</a> and retrieved with <a href="#server-getGlobal">getGlobal</a> (or <a href="#server-modGlobal">modGlobal</a>) will be stored within an object named 'variableSandbox' within the standard global object - meaning that the extension cannot access global variables from other extensions with no or different sandboxes, however extensions with no sandbox can access the variables be getting the global variable named 'variableSandbox' - which will be an object of the variables.
	<br>
	If host limits are used (so mode &gt;= 1), the extension will only be allowed to handle events for that domain, so if 'hosts' is ["www.example.com"], then any handles created by it for "request" or similar events will only handle these events for requests to "www.example.com", so it will not be allowed to handle events for "www.jotpot.co.uk".
	<br>
	Mode can only be 0, 1 or 2 (defaults to 2). If mode is 0, only the variable sandbox will be applied, if mode is 1, variable sandbox will be applied and the host limits will be applied, mode 2 behaves identically to mode 1 right now however new behavior will be added in the future for mode 2.
	<br>
	The object created should be used when calling <a href="#server-loadExt">server.loadExt()</a>
</div></div><div ID="server-modGlobal"><h3 class="func-h3">server.modGlobal(variableName)</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="supported">Yes</span></li></ul>Added: 25B</div><ul class="args-list"><li>variableName &lt;String&gt; Name of the variable to modify.</li></ul><div class="desc">	Same as calling <a href="#server-getGlobal">server.getGlobal(variableName, true)</a>
</div></div><div ID="server-multiPartFormDataParser"><h3 class="func-h3">server.multiPartFormDataParser(request, callback)</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="supported">Yes</span></li></ul>Added: 25E<br>Note: Not currently recomended due to lack of testing.</div><ul class="args-list"><li>request &lt;Server Request&gt; Request to parse the data from.</li><li>callback &lt;Function&gt; Function to be called with all new data.</li></ul><div class="desc">Returns a Promise, that resolves when all data has been recieved and parsed.<br>The callback is called whenever a new field is recieved. It is sent with a Data class as the only argument.<br>The Data class is an extension of the standard Node.js readable stream and the data recieved for the current field will be piped out of it. It also has 3 extra popities: name, headers and setup. The name property contains the name of the field, headers contains an object of the parsed headers of the field, and setup is used for internal use.</div></div><div ID="server-pages"><h3 class="func-h3">server.pages</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">	Variables used for caching, documentation coming soon.
</div></div><div ID="server-reloadConfig"><h3 class="func-h3">server.reloadConfig()</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: 25A<br>Note: Not available in the master process until 25D</div><ul class="args-list"></ul><div class="desc">	Reloads the config.json file.
</div></div><div ID="server-sendCache"><h3 class="func-h3">server.sendCache(file, response, request)</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: 25E</div><ul class="args-list"><li>file &lt;String&gt; URL to send coresponding file for.</li><li>response &lt;Server Response&gt; The response to send the error to.</li><li>request &lt;Server Request&gt; Optional, the request to get the ID from for improved logging.</li></ul><div class="desc">Exposes an internal function that has been around scince the first release.<br>server.sendCache sends a cache to the response. The cache argument is writen to the response into Node.js's <a href="">response.write</a>, so any type that can be writen to that will be acceptable as the cache argument.<br>The code argument specifies the response code to be sent.<br>Returns a promise that rejects on an unexpected error, and resolves with an array. Index 0 of this array is a boolean, true if the response was sent succesfully and false if not. If index 0 is false, index 1 is the error.<br>Chunked encoding is used unless there are no pipes, in which case the content-length header will be set the the length property of the cache argument.</div></div><div ID="server-sendError"><h3 class="func-h3">server.sendError(code, message, response)</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: Pre 25A</div><ul class="args-list"><li>code &lt;Number&gt; HTTP response code to send.</li><li>message &lt;String&gt; The message to display on the error page.</li><li>response &lt;Server Response&gt; The response to send the error to.</li></ul><div class="desc">	Sends a full response based on the error code with the 'errorTemp.jpt' file (from the working directory of the server) with all the error details.
</div></div><div ID="server-sendFile"><h3 class="func-h3">server.sendFile(file, response, request)</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: 25E</div><ul class="args-list"><li>file &lt;String&gt; URL to send coresponding file for.</li><li>response &lt;Server Response&gt; The response to send the error to.</li><li>request &lt;Server Request&gt; Optional, the request to get the ID from for improved logging.</li></ul><div class="desc">Exposes an internal function that has been around scince the first release.<br>server.sendFile sends the correct file as the response to the request. For example if file is 'example.com/hello.html', it will serve './sites/example.com/hello.html'.<br>Returns a promise that rejects on an unexpected error, and resolves with an array. Index 0 of this array is a boolean, true if the response was sent succesfully and false if not. If index 0 is false, index 1 is the error.<br>It pipes through all the correct pipes, including the vars pipe if it should be added for the file given. Chunked encoding is used unless there are no pipes, in which case the content-length header is set to the size of the file being served.</div></div><div ID="server-setFunc"><h3 class="func-h3">server.setFunc(functionName, function)</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="notsupported">No</span></li><li>Limited master extention: <span class="supported">Yes</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: 25A</div><ul class="args-list"><li>functionName &lt;String&gt; Name of the function to set.</li><li>function &lt;Function&gt; The function to assign to the function name.</li></ul><div class="desc">Sets a function that can be called by any of the workers via <a href="#server-callFunc">server.callFunc()</a>. Each seperate lock gets its own scope for functions - based on the variable scope.</div></div><div ID="server-setGlobal"><h3 class="func-h3">server.setGlobal(variableName, value)</h3><div class="details">Availability:<ul><li>Master extention: <span class="supported">Yes</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="supported">Yes</span></li><li>Limited worker extention: <span class="supported">Yes</span></li></ul>Added: Pre 25A</div><ul class="args-list"><li>variableName &lt;String&gt; Name of the variable to retrieve.</li><li>value Value to set the variable to.</li></ul><div class="desc">	Sets a server wide global variable. In the master process, it will resolve instantly.
	<br>
	Returns a Promise, resolves when the value of the variable has been set.
	<br>
	See also: <a href="#server-getGlobal">server.getGlobal()</a>
</div></div><div ID="server-vars"><h3 class="func-h3">server.vars</h3><div class="details">Availability:<ul><li>Master extention: <span class="notsupported">No</span></li><li>Worker extention: <span class="supported">Yes</span></li><li>Limited master extention: <span class="notsupported">No</span></li><li>Limited worker extention: <span class="notsupported">No</span></li></ul>Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">	Object containing global variables to be inserted into pages.
	<br>
	If server.vars = {'test1':'hi','test2':'world'}, then in a page served containing the contents '$:::test1:::$ - $:::test2:::$' will be served as 'hi - world'.
	<br>
	Note that <a href="#response-vars">ServerResponse.vars</a> will also be added this way, with a higher priority (with a lower priority until 25D).
</div></div>
</div>
<br><br>
<h2>
	Server Events
</h2>
<div class="indent">
	JOTPOT Server has a serese of events that extensions can handle to add behavior to or to overwrite the behavior of.
	<br>
	Please see server.handle() for handling events.
	<br>
	<h3>
		Events:
	</h3>
	<ul>
		<li>'ready' event: This is the first event to fire, this event is fired when the current process is up and ready. This is fired for both master extensions and worker extensions and is the only event currently for master extensions. It cannot be overwritten, so the return value is ignored. The handler is called with no arguments.</li>
		<li>'request' event: This event is fired whenever a request is received, this event is fired before any redirects happen, such as redirects to HTTPS or redirects to the login page, so this should generally not be handled. The default behavior can be overwritten to if the handler returns true or returns a promise that resolves true, JOTPOT Server will stop handling the request. The handler is called with 2 arguments, the request object and the response object.</li>
		<li>'&lt;domain&gt;/request' event: This is the equivalent to the 'request' event however only fires for the domain before the '/'</li>
		<li>'fullrequest' event: This event is fired after a request is redirected and has page/host aliases applied, this event is however fired before any authentication checks happen, so this should generally not be handled if an account system is active of the page. The default behavior can be overwritten to if the handler returns true or returns a promise that resolves true, JOTPOT Server will stop handling the request. The handler is called with 2 arguments, the request object and the response object.</li>
		<li>'&lt;domain&gt;/fullrequest' event: This is the equivalent to the 'fullrequest' event however only fires for the domain before the '/'</li>
		<li>'allowedrequest' event: This event is fired when the server is ready to respond to the event, the user will have gone through all redirects, any aliases will have been applied and the user will be authenticated to access the page they are requesting. In most cases, this is the best event to handle for server side rendering, analytics and most other use cases.</li>
		<li>'&lt;domain&gt;/allowedrequest' event: This is the equivalent to the 'allowedrequest' event however only fires for the domain before the '/'</li>
	</ul>
</div>
<br><br>
<h2>
	Using server.handle
</h2>
<div class="indent">
	So, lets say you want to render a page serverside for the user, you could use the serveer.handle function to create this functionality.
	<br>
	When you handle any request event, so 'request', 'fullrequest', 'allowedrequest' or any host specific request, the handler function will receive 2 arguments, the request and the response object. These are documented below.
	<br>
	Here is an example:
	<pre>
	//Handle the request when we know it is allowed, to ensure that
	// we don't serve a page to a user that isn't logged in.
	server.handle('allowedrequest', (req, resp) => {
		
		//The request and response object have everything the standard
		// Node.js objects have however with some modified properties
		// and some additional ones.
		
		//Note how the domain is at the start of the req.url, see
		// req.url in the request docs below for how it is different.
		// You might also want to use req.purl here instead.
		if (req.url === 'www.exmaple.com/content.html') {
			
			//Call you own function to hamdle the request and the
			// response as you would in any other Node.js server.
			renderContentPage(req, resp) ;
			
			//Return true to say that this has handled the event
			// so the default behavior gets overwritten.
			return true ;
			
		}
		
		//If we haven't handled it, return false so the server 
		// continues with the default behavior for the request.
		return false ;
		
	});
	</pre>
</div>
<br>
<h2>
	The 'request' ('IncomingMessage') object.
</h2>
<div class="indent">
	The 'request' object is passed as the first argument to any hander function handling a request - with the second argument always been the response object. It is the <a href="https://nodejs.org/dist/latest-v6.x/docs/api/http.html#http_class_http_incomingmessage">Node.js IncomingMessage object</a> however has some modified properties and some added properties to make working with it easier. All of these changed/additional properties are listed below.
</div>
<div class="indent">
<div ID="request-accualHost"><h3 class="func-h3">request.accualHost</h3><div class="details">Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">Similar to request.orig_url, it is the host the request was originally made with, thus this is without the host alias applied.<br>This is not available for the request handle.</div></div><div ID="request-fullurl"><h3 class="func-h3">request.fullurl</h3><div class="details">Added: 25A</div><ul class="args-list"></ul><div class="desc">This is what will appear in the users URL bar, for example 'https://www.example.com:443/path/to/page.html'. Note that these elements will always be included.</div></div><div ID="request-host"><h3 class="func-h3">request.host</h3><div class="details">Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">request.host will be equal to the domain the request is been made to, after aliases have been handled, so for the fullrequest and allowedrequest events, it will be the alias.<br>This is not available for the request handle.</div></div><div ID="request-ip"><h3 class="func-h3">request.ip</h3><div class="details">Added: 25E</div><ul class="args-list"></ul><div class="desc">request.ip if the IP address of the user making the request. If there is an x-forwarded-for header, the IP address is set the that over the accual IP address.<br>If config.behindLoadBalancer is true, the jp-source-ip header set by the load balancer will be used as the source IP.<br>Also see <a href="#request-sourceIp">request.sourceIp</a>.</div></div><div ID="request-orig_url"><h3 class="func-h3">request.orig_url</h3><div class="details">Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">This will be the original URL requested by the client. See <a href="#request-url">request.url</a> for details on how it is changed.<br>This is not available for the request handle.</div></div><div ID="request-overHttps"><h3 class="func-h3">request.overHttps</h3><div class="details">Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">Alias for <a href="request-secure">request.secure</a> (was added before request.secure and left in for backwards compatibility purposes), so true if the request was made over HTTPS and false if not.</div></div><div ID="request-path"><h3 class="func-h3">request.path</h3><div class="details">Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">The requested path (thus without the host) with all occurrences of '..' removed.<br>This is not available for the request handle.</div></div><div ID="request-pathname"><h3 class="func-h3">request.pathname</h3><div class="details">Added: 25E</div><ul class="args-list"></ul><div class="desc"><a href="#request-path">request.path</a> however without the query.<br>This is not available for the request handle.</div></div><div ID="request-purl"><h3 class="func-h3">request.purl</h3><div class="details">Added: 25A</div><ul class="args-list"></ul><div class="desc">Equivalent to if request.fullurl was passed to <a href="https://nodejs.org/dist/latest-v6.x/docs/api/url.html">Node.js's url.parse</a>.</div></div><div ID="request-secure"><h3 class="func-h3">request.secure</h3><div class="details">Added: 25D</div><ul class="args-list"></ul><div class="desc">Whether or not the request and response is secure, so true if the request was made over HTTPS and false if not.<br>From 25E onwards, if config.behindLoadBalancer is true, the jp-source-secure header set by the load balancer will be set, even if the load balancer made the request via HTTP to the server, the value will be determined by the clients connection to the load balancer.</div></div><div ID="request-secureToServer"><h3 class="func-h3">request.secureToServer</h3><div class="details">Added: 25D</div><ul class="args-list"></ul><div class="desc">Whether or not the connection to the load balancer is HTTPS. If there is no load balancer, it is equal to <a href="#request-secure">request.secure</a></div></div><div ID="request-remoteAddress"><h3 class="func-h3">request.remoteAddress</h3><div class="details">Added: 25E</div><ul class="args-list"></ul><div class="desc">request.remoteAddress if the IP address of the client making the request. Unlike <a href="#request-ip">request.ip</a>, it ignores the x-forwarded-for header.<br>If config.behindLoadBalancer is true, the jp-source-ip header set by the load balancer will be used as the source IP.</div></div><div ID="request-url"><h3 class="func-h3">request.url</h3><div class="details">Added: Pre 25A<br>Note: Before 1.2.0, request.url was all lower case.</div><ul class="args-list"></ul><div class="desc">The URL that the client requested, however with all occurrences of '..' removed to prevent the request from going into a parent directory. It also has the host concatenated before the path, so a request for '/hello.html' with the host 'www.example.com', req.url would be 'www.example.com/hello.html'.<br>This is not modified for the request handle.</div></div><div ID="request-user"><h3 class="func-h3">request.user</h3><div class="details">Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">This is the user ID of the user of the current user, please note that this is only set when it is required for the user to be authenticated for the page. And thus also only available in the allowedrequest handle.</div></div>
</div>
<br><br>
<h2>
	The 'response' ('ServerResponse') object.
</h2>
<div class="indent">
	The 'response' object is always passed to the request hander as the second argument, and similar to the 'request' object is the <a href="https://nodejs.org/dist/latest-v6.x/docs/api/http.html#http_class_http_serverresponse">Node.js ServerResponse object</a> however with a couple of added properties for ease of use. These added properties are documented below.
</div>
<div class="indent">
<div ID="response-pipeThrough"><h3 class="func-h3">response.pipeThrough</h3><div class="details">Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">This is an array that by default is empty. When the response is sent, it will be piped through all the pipes in this array before been piped to the client, meaning that you can add compression transform pipes, some templating solutions or more to this array and your response will be sent through them.</div></div><div ID="response-vars"><h3 class="func-h3">response.vars</h3><div class="details">Added: Pre 25A</div><ul class="args-list"></ul><div class="desc">These are variables processed in the same way as <a href="#server-vars">server.vars</a> however these are only for the current response and will overwrite any global variables.</div></div>
</div>
</div>
</div>
<jp-data-title>JOTPOT Server Docs</jp-data-title>
<script type="text/javascript">
	addClickListener(document.getElementById("the_link")) ;
</script>